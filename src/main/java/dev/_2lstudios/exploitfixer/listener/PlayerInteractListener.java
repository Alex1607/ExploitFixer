package dev._2lstudios.exploitfixer.listener;

import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.PlayerInventory;

import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.modules.PatcherModule;

public class PlayerInteractListener implements Listener {
    private PatcherModule patcherModule;
    private NotificationsModule notificationsModule;

    public PlayerInteractListener(ModuleManager moduleManager) {
        this.patcherModule = moduleManager.getPatcherModule();
        this.notificationsModule = moduleManager.getNotificationsModule();
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.LOW)
    public void onPlayerInteract(PlayerInteractEvent event) {
        // Check if patching of duplication beds is enabled
        if (patcherModule.isBedDuplication()) {
            // Get player
            Player player = event.getPlayer();

            // Get player inventory
            PlayerInventory inventory = player.getInventory();

            // Get held item
            ItemStack heldItem = inventory.getItem(inventory.getHeldItemSlot());

            // Check if held item exists
            if (heldItem != null) {
                // Get held item type name
                String heldItemTypeName = heldItem.getType().name();

                // Check if the held item is a bed
                if (heldItemTypeName.endsWith("_BED") || heldItemTypeName.equals("BED")) {
                    // Get the clicked block
                    Block block = event.getClickedBlock();

                    // Check if block exists
                    if (block != null) {
                        // Get the name of the type of the block
                        String blockTypeName = block.getType().name();

                        // Check if the block is a growing crop
                        if (blockTypeName.equals("WHEAT") || blockTypeName.equals("POTATOES")
                                || blockTypeName.equals("POTATO") || blockTypeName.equals("CARROTS")
                                || blockTypeName.equals("CARROT") || blockTypeName.equals("NETHER_WARTS")
                                || blockTypeName.equals("BEETROOTS")) {
                            // Cancel the event
                            event.setCancelled(true);
                            // Notify
                            notificationsModule.debug("[Patcher] Player " + event.getPlayer().getName()
                                    + " is trying to duplicate crops with beds.");
                        }
                    }
                }
            }
        }
    }
}
