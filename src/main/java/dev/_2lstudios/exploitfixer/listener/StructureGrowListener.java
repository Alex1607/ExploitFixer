package dev._2lstudios.exploitfixer.listener;

import org.bukkit.World;
import org.bukkit.block.Block;
import org.bukkit.block.BlockState;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.world.StructureGrowEvent;

import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.EventsModule;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;

public class StructureGrowListener implements Listener {
    private final NotificationsModule notificationsModule;
    private final EventsModule eventsModule;

    StructureGrowListener(final ModuleManager moduleManager) {
        this.notificationsModule = moduleManager.getNotificationsModule();
        this.eventsModule = moduleManager.getEventsModule();
    }

    @EventHandler(priority = EventPriority.LOW, ignoreCancelled = true)
    public void onStructureGrow(StructureGrowEvent event) {
        if (eventsModule.isEnderPortalBreak()) {
            World world = event.getWorld();

            for (BlockState blockBefore : event.getBlocks()) {
                Block block = world.getBlockAt(blockBefore.getLocation());

                if (block.getType().name().equals("ENDER_PORTAL_FRAME")
                        || block.getType().name().equals("END_PORTAL_FRAME")) {
                    event.setCancelled(true);
                    notificationsModule.debug("[Events] A mushroom tried to break an ender portal frame.");
                }
            }
        }
    }
}
